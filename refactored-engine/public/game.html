<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Factory of Plex</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        overflow: hidden;
        background: #000;
      }

      #canvas-container {
        width: 100vw;
        height: 100vh;
      }

      #ui-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }

      .crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 30px;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 50%;
        pointer-events: none;
      }

      .crosshair::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 4px;
        height: 4px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 50%;
      }

      .hud {
        position: absolute;
        bottom: 20px;
        left: 20px;
        color: #00ff00;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.5;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border: 1px solid #00ff00;
        max-width: 300px;
      }

      .inventory {
        position: absolute;
        right: 20px;
        top: 20px;
        color: #00ff00;
        font-family: 'Courier New', monospace;
        background: rgba(0, 0, 0, 0.9);
        padding: 15px;
        border: 2px solid #00ff00;
        max-width: 300px;
        max-height: 400px;
        overflow-y: auto;
        display: none;
        pointer-events: all;
      }

      .inventory.active {
        display: block;
      }

      .inventory-header {
        margin-bottom: 10px;
        border-bottom: 1px solid #00ff00;
        padding-bottom: 5px;
        font-weight: bold;
      }

      .inventory-item {
        padding: 8px 10px;
        cursor: pointer;
        transition: all 0.3s;
        border-left: 2px solid transparent;
      }

      .inventory-item:hover {
        background: rgba(0, 255, 0, 0.2);
        border-left: 2px solid #00ff00;
      }

      .lore-entry {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.95);
        border: 2px solid #00ff00;
        padding: 30px;
        max-width: 600px;
        max-height: 70vh;
        overflow-y: auto;
        display: none;
        z-index: 100;
        color: #00ff00;
        font-family: 'Courier New', monospace;
        pointer-events: all;
      }

      .lore-entry.active {
        display: block;
      }

      .lore-entry h2 {
        margin-bottom: 20px;
        border-bottom: 1px solid #00ff00;
        padding-bottom: 10px;
      }

      .lore-entry p {
        margin-bottom: 15px;
        line-height: 1.6;
        white-space: pre-wrap;
      }

      .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #00ff00;
        color: #000;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        font-weight: bold;
        pointer-events: all;
      }

      .warning {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: #ff0000;
        font-size: 18px;
        font-weight: bold;
        text-shadow: 0 0 10px #ff0000;
        animation: pulse 0.5s infinite alternate;
      }

      @keyframes pulse {
        from { opacity: 0.5; }
        to { opacity: 1; }
      }

      .start-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 900;
        color: #00ff00;
        font-family: 'Courier New', monospace;
        text-align: center;
      }

      .start-screen.hidden {
        display: none;
      }

      .start-screen h1 {
        font-size: 64px;
        margin-bottom: 10px;
        text-shadow: 0 0 30px #00ff00;
        letter-spacing: 3px;
      }

      .start-screen .subtitle {
        font-size: 20px;
        margin-bottom: 50px;
        color: #00aa00;
        text-shadow: 0 0 10px #00ff00;
      }

      .button-container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        pointer-events: all;
      }

      .start-button {
        padding: 15px 40px;
        font-size: 18px;
        background: transparent;
        color: #00ff00;
        border: 2px solid #00ff00;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        text-transform: uppercase;
        letter-spacing: 2px;
        transition: all 0.3s;
        pointer-events: all;
      }

      .start-button:hover {
        background: #00ff00;
        color: #000;
        text-shadow: none;
        box-shadow: 0 0 20px #00ff00;
      }

      .screen-content {
        background: rgba(0, 0, 0, 0.85);
        padding: 30px;
        border: 2px solid #00ff00;
        max-width: 700px;
        max-height: 60vh;
        overflow-y: auto;
        margin-bottom: 30px;
        display: none;
        pointer-events: all;
      }

      .screen-content.active {
        display: block;
      }

      .screen-content h2 {
        margin-bottom: 20px;
        text-shadow: 0 0 10px #00ff00;
      }

      .screen-content p {
        text-align: left;
        margin-bottom: 15px;
        line-height: 1.6;
      }

      .back-button {
        position: absolute;
        top: 20px;
        left: 20px;
        padding: 10px 20px;
        background: transparent;
        color: #00ff00;
        border: 1px solid #00ff00;
        cursor: pointer;
        font-family: 'Courier New', monospace;
        transition: all 0.3s;
        pointer-events: all;
      }

      .back-button:hover {
        background: #00ff00;
        color: #000;
      }

      .back-button.hidden {
        display: none;
      }

      .game-over {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 800;
        color: #ff0000;
        font-family: 'Courier New', monospace;
        text-align: center;
      }

      .game-over.active {
        display: flex;
      }

      .game-over h1 {
        font-size: 48px;
        margin-bottom: 20px;
        text-shadow: 0 0 20px #ff0000;
      }

      .game-over p {
        font-size: 20px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div id="canvas-container"></div>
    <div id="ui-container">
      <div class="start-screen" id="start-screen">
        <button class="back-button hidden" id="back-button" onclick="showMainMenu()">← BACK</button>
        <h1>THE FACTORY OF PLEX</h1>
        <p class="subtitle">Uncover the truth. Survive the deformed.</p>
        <div class="button-container" id="main-menu-buttons">
          <button class="start-button" onclick="startGame()">PLAY</button>
          <button class="start-button" onclick="showScreen('objectives')">OBJECTIVE</button>
          <button class="start-button" onclick="showScreen('controls')">CONTROLS</button>
        </div>
        <div class="screen-content" id="objectives-screen">
          <h2>OBJECTIVE</h2>
          <p><strong>Your Mission:</strong> Recover 8 lore items scattered throughout the abandoned factory.</p>
          <p><strong>The Items:</strong></p>
          <p>• Letters from Carlos and Plex discussing the toys' fate</p>
          <p>• Diary entries from the awakened toys themselves</p>
          <p>• Security tape transcripts of the evacuation</p>
          <p>• Scientific reports documenting the transformation</p>
          <p><strong>The Threat:</strong> The deformed creatures hunt you. Stay silent, stay hidden, stay alive.</p>
          <p><strong>The Truth:</strong> Piece together what happened at the Factory of Plex through the letters and notes left behind.</p>
        </div>
        <div class="screen-content" id="controls-screen">
          <h2>CONTROLS</h2>
          <p><strong>Movement:</strong></p>
          <p>• W - Move Forward</p>
          <p>• A - Strafe Left</p>
          <p>• S - Move Backward</p>
          <p>• D - Strafe Right</p>
          <p><strong>Interaction:</strong></p>
          <p>• MOUSE - Look Around (Click to enable)</p>
          <p>• E - Open/Close Inventory</p>
          <p>• Click Inventory Items - Read Lore Entry</p>
          <p><strong>Game:</strong></p>
          <p>• R - Restart After Death</p>
        </div>
      </div>
      <div class="crosshair"></div>
      <div class="warning" id="warning" style="display: none;">⚠ DEFORMED DETECTED ⚠</div>
      <div class="hud" id="hud">
        <div>POSITION: <span id="pos-x">0</span>, <span id="pos-y">0</span>, <span id="pos-z">0</span></div>
        <div>HEALTH: <span id="health">100</span>/100</div>
        <div>COLLECTED: <span id="collected">0</span>/8</div>
        <div style="margin-top: 10px; border-top: 1px solid #00ff00; padding-top: 10px; font-size: 12px;">Press E for Inventory</div>
      </div>
      <div class="inventory" id="inventory">
        <div class="inventory-header">INVENTORY (E to close)</div>
        <div id="inventory-list"></div>
      </div>
      <div class="lore-entry" id="lore-entry">
        <button class="close-button" onclick="closeLoreEntry()">CLOSE</button>
        <h2 id="lore-title"></h2>
        <div id="lore-content"></div>
      </div>
      <div class="game-over" id="game-over">
        <h1 id="game-over-title">YOU DIED</h1>
        <p id="game-over-text"></p>
        <p style="margin-top: 30px; font-size: 14px;">Press R to restart</p>
      </div>
    </div>
    <script>
      function startGame() {
        const startScreen = document.getElementById('start-screen');
        startScreen.classList.add('hidden');
        if (window.gameInstance) {
          window.gameInstance.resumeGame();
        }
      }

      function showScreen(screenId) {
        const backBtn = document.getElementById('back-button');
        const mainMenu = document.getElementById('main-menu-buttons');
        const objectivesScreen = document.getElementById('objectives-screen');
        const controlsScreen = document.getElementById('controls-screen');

        if (screenId === 'objectives') {
          mainMenu.style.display = 'none';
          objectivesScreen.classList.add('active');
          backBtn.classList.remove('hidden');
        } else if (screenId === 'controls') {
          mainMenu.style.display = 'none';
          controlsScreen.classList.add('active');
          backBtn.classList.remove('hidden');
        }
      }

      function showMainMenu() {
        const backBtn = document.getElementById('back-button');
        const mainMenu = document.getElementById('main-menu-buttons');
        const objectivesScreen = document.getElementById('objectives-screen');
        const controlsScreen = document.getElementById('controls-screen');

        mainMenu.style.display = 'flex';
        objectivesScreen.classList.remove('active');
        controlsScreen.classList.remove('active');
        backBtn.classList.add('hidden');
      }

      function closeLoreEntry() {
        const entry = document.getElementById('lore-entry');
        entry.classList.remove('active');
        if (window.gameInstance) {
          window.gameInstance.resumeGame();
        }
      }

      function toggleInventory() {
        const inventory = document.getElementById('inventory');
        inventory.classList.toggle('active');
      }
    </script>
    <!-- Log overlay (toggle with Ctrl+H) -->
    <div id="log-overlay" style="position:fixed;right:10px;top:10px;width:360px;max-height:80vh;background:rgba(10,10,10,0.92);color:#dcdcdc;font-family:monospace;font-size:12px;border:1px solid #444;z-index:2000;display:none;box-shadow:0 6px 20px rgba(0,0,0,0.6);display:flex;flex-direction:column;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;padding:10px;border-bottom:1px solid #444;flex-shrink:0;">
        <strong style="color:#fff">Console Log</strong>
        <button id="clear-log" style="background:#222;color:#fff;border:1px solid #333;padding:2px 6px;cursor:pointer">Clear</button>
      </div>
      <div id="log-messages" style="overflow-y:auto;padding:10px;flex:1;"></div>
    </div>

    <script>
      (function () {
        const overlay = document.getElementById('log-overlay')
        const messages = document.getElementById('log-messages')
        const clearBtn = document.getElementById('clear-log')

        function formatMessage(type, args) {
          try {
            const text = Array.from(args).map(a => {
              if (typeof a === 'object') {
                if (a instanceof Error) {
                  return `${a.name}: ${a.message} ${a.stack ? '\n' + a.stack : ''}`
                }
                return JSON.stringify(a)
              }
              return String(a)
            }).join(' ')
            const time = new Date().toISOString().split('T')[1].replace('Z','')
            return `<div style="margin-bottom:6px"><span style="color:#6cf">[${time}]</span> <span style="color:${type==='error'?'#ff6b6b':type==='warn'?'#ffd866':'#dcdcdc'}">${type.toUpperCase()}</span>: ${text}</div>`
          } catch (e) {
            return `<div>${type}: (could not format message)</div>`
          }
        }

        // Capture console methods
        ;['log','info','warn','error'].forEach((m) => {
          const orig = console[m]
          console[m] = function () {
            try {
              if (messages) {
                messages.innerHTML = messages.innerHTML + formatMessage(m, arguments)
                messages.scrollTop = messages.scrollHeight
              }
            } catch (e) {
              // ignore
            }
            try { orig.apply(console, arguments) } catch (e) {}
          }
        })

        // Also capture uncaught errors
        window.addEventListener('error', (ev) => {
          if (messages) {
            const errorMsg = `${ev.message} (${ev.filename}:${ev.lineno}:${ev.colno})`
            messages.innerHTML = messages.innerHTML + formatMessage('error', [errorMsg])
            messages.scrollTop = messages.scrollHeight
          }
        })
        window.addEventListener('unhandledrejection', (ev) => {
          if (messages) {
            const reason = ev.reason instanceof Error ? `${ev.reason.name}: ${ev.reason.message}` : String(ev.reason)
            messages.innerHTML = messages.innerHTML + formatMessage('error', [reason])
            messages.scrollTop = messages.scrollHeight
          }
        })

        // Toggle overlay with Ctrl+H
        window.addEventListener('keydown', (e) => {
          if (e.key.toLowerCase() === 'h' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault()
            if (!overlay) return
            overlay.style.display = overlay.style.display === 'none' ? 'block' : 'none'
          }
        })

        if (clearBtn) clearBtn.addEventListener('click', () => { if (messages) messages.innerHTML = '' })
      })()
    </script>

    <script type="module">
      // Execute the app entry which instantiates and starts the game
      import('../src/main.ts')
    </script>
  </body>
</html>
